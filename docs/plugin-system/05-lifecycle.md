# 5. 插件生命周期

Buddy 插件从安装到卸载，经历完整的生命周期，系统在各个阶段调用相应的钩子函数。

## 生命周期概览

```
               ┌─────────────┐
               │    安装     │
               └──────┬──────┘
                      │
                      ▼
               ┌─────────────┐
               │    加载     │
               └──────┬──────┘
                      │
                      ▼
               ┌─────────────┐
               │   初始化    │
               └──────┬──────┘
                      │
                      ▼
               ┌─────────────┐
        ┌─────▶│    激活     │◀─────┐
        │      └──────┬──────┘      │
        │             │             │
        │             ▼             │
┌───────┴─────┐ ┌─────────────┐ ┌───┴───────┐
│    停用     │ │    运行     │ │   更新    │
└───────┬─────┘ └──────┬──────┘ └───────────┘
        │             │
        │             ▼
        │      ┌─────────────┐
        └─────▶│    卸载     │
               └─────────────┘
```

## 各阶段详解

### 1. 安装阶段

- **触发条件**：用户安装插件
- **操作**：
  - 下载或复制插件包
  - 解压到插件目录
  - 验证插件格式和兼容性
  - 添加到插件注册表

### 2. 加载阶段

- **触发条件**：应用启动或插件安装后
- **操作**：
  - 读取插件清单
  - 加载插件主文件
  - 准备插件运行环境

### 3. 初始化阶段

- **触发条件**：插件首次加载
- **钩子函数**：`initialize()`
- **操作**：
  - 检查环境依赖
  - 创建必要的资源
  - 初始化插件状态

### 4. 激活阶段

- **触发条件**：手动激活或自动激活（根据配置）
- **钩子函数**：`activate()`
- **操作**：
  - 注册视图、命令和菜单
  - 订阅事件
  - 启动后台服务

### 5. 运行阶段

- **触发条件**：插件激活后
- **操作**：
  - 响应用户交互
  - 执行预定义功能
  - 与系统交互

### 6. 停用阶段

- **触发条件**：手动停用或应用退出
- **钩子函数**：`deactivate()`
- **操作**：
  - 取消注册视图和命令
  - 取消事件订阅
  - 停止后台服务
  - 释放资源

### 7. 更新阶段

- **触发条件**：安装新版本
- **操作**：
  - 停用旧版本
  - 安装新版本
  - 迁移配置和数据
  - 激活新版本

### 8. 卸载阶段

- **触发条件**：用户卸载插件
- **操作**：
  - 停用插件
  - 清理插件文件
  - 移除插件注册信息

## 钩子函数实现

插件开发者需要在插件主文件中实现以下钩子函数：

```javascript
export default {
  /**
   * 在插件加载后调用，用于初始化插件
   */
  async initialize() {
    // 初始化代码
    console.log('插件初始化中...');
    return true;
  },
  
  /**
   * 在插件激活时调用，用于注册功能和启动服务
   */
  async activate() {
    // 激活代码
    console.log('插件已激活');
    
    // 注册视图、命令等
    this.registerViews();
    this.registerCommands();
    
    // 启动后台服务
    this.startBackgroundService();
    
    return true;
  },
  
  /**
   * 在插件停用时调用，用于清理资源
   */
  async deactivate() {
    // 停用代码
    console.log('插件停用中...');
    
    // 取消注册功能
    this.unregisterViews();
    this.unregisterCommands();
    
    // 停止后台服务
    this.stopBackgroundService();
    
    return true;
  }
};
```

## 插件状态机

插件系统内部使用状态机管理插件状态：

- **已安装 (Installed)**：插件已安装但未加载
- **已加载 (Loaded)**：插件已加载但未初始化
- **已初始化 (Initialized)**：插件已初始化但未激活
- **已激活 (Activated)**：插件已激活并运行中
- **已停用 (Deactivated)**：插件已停用
- **出错 (Error)**：插件在某个阶段出现错误

状态转换图：

```
                    ┌────────────┐
                 ┌─▶│  Installed │
                 │  └──────┬─────┘
                 │         │ load()
                 │         ▼
                 │  ┌────────────┐
 install()       │  │   Loaded   │
┌─────────┐      │  └──────┬─────┘
│ Not     │──────┘         │ initialize()
│Installed│                 ▼
└─────────┘      ┌─▶┌────────────┐
     ▲           │  │Initialized │
     │           │  └──────┬─────┘
     │           │         │ activate()
     │           │         ▼
     │     ┌─────┴──┐┌────────────┐
     └─────┤ Error  │◀┤  Activated │
           └────────┘│            │◀┐
                     └──────┬─────┘ │
                            │       │
                            │       │ update()
                            ▼       │
                     ┌────────────┐ │
                     │Deactivated │─┘
                     └────────────┘
                            │
                            │ uninstall()
                            ▼
```

## 事件系统

插件系统在生命周期的各个阶段触发事件，允许其他组件监听并响应：

```typescript
// 监听插件安装事件
pluginManager.on('plugin:installed', (pluginId) => {
  console.log(`插件 ${pluginId} 已安装`);
});

// 监听插件激活事件
pluginManager.on('plugin:activated', (pluginId) => {
  console.log(`插件 ${pluginId} 已激活`);
});

// 监听插件停用事件
pluginManager.on('plugin:deactivated', (pluginId) => {
  console.log(`插件 ${pluginId} 已停用`);
});

// 监听插件卸载事件
pluginManager.on('plugin:uninstalled', (pluginId) => {
  console.log(`插件 ${pluginId} 已卸载`);
});
``` 
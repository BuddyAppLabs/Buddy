# 2. 插件系统架构设计

Buddy 插件系统采用模块化设计，由多个协同工作的组件组成，以提供完整的插件管理生命周期。

## 整体架构

```ascii
+----------------------------------+
|             Buddy App            |
+----------------------------------+
|                                  |
|  +------------------------------+|
|  |        Plugin Manager        ||
|  |                              ||
|  |  +------------------------+  ||
|  |  |   Plugin Installer     |  ||
|  |  +------------------------+  ||
|  |                              ||
|  |  +------------------------+  ||
|  |  |    Plugin Loader       |  ||
|  |  +------------------------+  ||
|  |                              ||
|  |  +------------------------+  ||
|  |  |   Plugin Registry      |  ||
|  |  +------------------------+  ||
|  |                              ||
|  +------------------------------+|
|                                  |
|  +------------------------------+|
|  |        Plugin Host           ||
|  |  +------------------------+  ||
|  |  |  Plugin 1  | Plugin 2  |  ||
|  |  +------------------------+  ||
|  |  |  Plugin 3  | Plugin 4  |  ||
|  |  +------------------------+  ||
|  +------------------------------+|
|                                  |
+----------------------------------+
         |            |
         v            v
+------------------+  +------------------+
| Electron Main    |  | Electron Renderer|
+------------------+  +------------------+
```

## 核心组件

### 1. 插件管理器 (Plugin Manager)

插件管理器是整个系统的核心，负责协调其他组件工作。主要功能包括：

- 统一的插件管理接口
- 启动时初始化插件系统
- 协调插件的安装、加载和运行

### 2. 插件安装器 (Plugin Installer)

负责插件的安装和卸载流程：

- 从 URL 或本地文件安装插件
- 验证插件包的完整性和格式
- 解压插件到正确的目录
- 处理插件的更新
- 清理卸载的插件文件

### 3. 插件加载器 (Plugin Loader)

负责加载和初始化插件：

- 扫描插件目录
- 解析插件清单
- 验证插件兼容性
- 加载插件主文件
- 执行插件的初始化逻辑

### 4. 插件注册表 (Plugin Registry)

维护插件的元数据和状态：

- 存储已安装插件的信息
- 跟踪插件的启用/禁用状态
- 管理插件的配置数据
- 提供插件查询接口

### 5. 插件宿主 (Plugin Host)

为插件提供运行环境：

- 提供 API 接口给插件
- 隔离插件执行环境
- 管理插件的权限
- 处理插件间通信

## 数据流

1. **安装流程**：用户提供插件 URL → 插件安装器下载并验证 → 解压到插件目录 → 更新插件注册表
2. **加载流程**：应用启动 → 插件加载器扫描目录 → 加载启用的插件 → 初始化插件 → 注册插件功能
3. **运行流程**：用户触发功能 → 插件宿主转发请求 → 插件执行操作 → 宿主返回结果

## 通信机制

- **主进程与渲染进程**：通过 Electron 的 IPC 机制通信
- **插件与宿主**：通过预定义的 API 接口通信
- **插件间通信**：通过事件系统或消息总线 